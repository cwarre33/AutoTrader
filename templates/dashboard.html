<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoTrader Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff;
    --green: #3fb950; --red: #f85149; --yellow: #d29922; --purple: #bc8cff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, 'Segoe UI', monospace; background: var(--bg); color: var(--text); }

  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; align-items: center; gap: 16px; }
  .header h1 { font-size: 18px; font-weight: 600; }
  .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
  .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.offline { background: var(--red); }
  .header-info { margin-left: auto; font-size: 13px; color: var(--muted); }

  .tabs { display: flex; background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; }
  .tab { padding: 10px 20px; cursor: pointer; color: var(--muted); font-size: 14px; border-bottom: 2px solid transparent; transition: all 0.2s; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .content { padding: 20px 24px; max-width: 1400px; margin: 0 auto; }
  .panel { display: none; }
  .panel.active { display: block; }

  /* Overview */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 24px; font-weight: 600; margin-top: 4px; }
  .stat-value.positive { color: var(--green); }
  .stat-value.negative { color: var(--red); }

  /* Positions table */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 24px; }
  .table-title { padding: 12px 16px; font-size: 14px; font-weight: 600; border-bottom: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 8px 12px; color: var(--muted); font-weight: 500; border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; }
  td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: rgba(88, 166, 255, 0.04); }
  .pl-positive { color: var(--green); }
  .pl-negative { color: var(--red); }

  /* Decisions / Cycles */
  .entry { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 10px; }
  .entry-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
  .entry-time { font-size: 12px; color: var(--muted); }
  .entry-action { font-size: 12px; font-weight: 600; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; }
  .action-buy { background: rgba(63, 185, 80, 0.15); color: var(--green); }
  .action-sell { background: rgba(248, 81, 73, 0.15); color: var(--red); }
  .action-hold { background: rgba(139, 148, 158, 0.15); color: var(--muted); }
  .entry-body { font-size: 13px; line-height: 1.5; }
  .entry-meta { font-size: 12px; color: var(--muted); margin-top: 6px; }

  .role-user { border-left: 3px solid var(--accent); }
  .role-assistant { border-left: 3px solid var(--green); }
  .role-error { border-left: 3px solid var(--red); }
  .thinking-block { background: rgba(188, 140, 255, 0.08); border: 1px solid rgba(188, 140, 255, 0.2); border-radius: 6px; padding: 10px; margin-top: 8px; font-size: 12px; color: var(--purple); white-space: pre-wrap; }

  /* Chat */
  .chat-container { display: flex; flex-direction: column; height: calc(100vh - 140px); }
  .chat-messages { flex: 1; overflow-y: auto; padding-bottom: 16px; }
  .chat-input-wrap { display: flex; gap: 10px; padding-top: 12px; border-top: 1px solid var(--border); }
  .chat-input { flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; color: var(--text); font-size: 14px; font-family: inherit; resize: none; }
  .chat-input:focus { outline: none; border-color: var(--accent); }
  .chat-send { background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 12px 24px; cursor: pointer; font-size: 14px; font-weight: 600; }
  .chat-send:hover { opacity: 0.9; }
  .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
  .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; }
  .chat-bubble.user { background: var(--accent); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
  .chat-bubble.bot { background: var(--surface); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .chat-bubble.error { background: rgba(248, 81, 73, 0.1); border: 1px solid var(--red); color: var(--red); }

  .refresh-btn { background: var(--surface); border: 1px solid var(--border); color: var(--muted); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 16px; }
  .refresh-btn:hover { color: var(--text); border-color: var(--accent); }
  .loading { color: var(--muted); font-style: italic; padding: 20px; text-align: center; }
  .empty { color: var(--muted); padding: 40px; text-align: center; font-size: 14px; }
</style>
</head>
<body>

<div class="header">
  <h1>AutoTrader</h1>
  <span class="status-dot" id="statusDot"></span>
  <span id="statusText" style="font-size:13px; color:var(--muted)">Checking...</span>
  <div class="header-info" id="headerInfo"></div>
</div>

<div class="tabs">
  <div class="tab active" data-panel="overview">Overview</div>
  <div class="tab" data-panel="decisions">Decisions</div>
  <div class="tab" data-panel="cycles">Cycles</div>
  <div class="tab" data-panel="chat">Chat</div>
</div>

<div class="content">
  <!-- Overview Panel -->
  <div class="panel active" id="panel-overview">
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card"><div class="stat-label">Equity</div><div class="stat-value" id="equity">--</div></div>
      <div class="stat-card"><div class="stat-label">Buying Power</div><div class="stat-value" id="buyingPower">--</div></div>
      <div class="stat-card"><div class="stat-label">Cash</div><div class="stat-value" id="cash">--</div></div>
      <div class="stat-card"><div class="stat-label">Open Positions</div><div class="stat-value" id="posCount">--</div></div>
      <div class="stat-card"><div class="stat-label">Unrealized P&L</div><div class="stat-value" id="totalPL">--</div></div>
      <div class="stat-card"><div class="stat-label">Last Cycle</div><div class="stat-value" id="lastCycle" style="font-size:14px">--</div></div>
    </div>
    <button class="refresh-btn" onclick="loadOverview()">Refresh</button>
    <div class="table-wrap">
      <div class="table-title">Positions</div>
      <table>
        <thead><tr><th>Ticker</th><th>Qty</th><th>Avg Entry</th><th>Current</th><th>Mkt Value</th><th>P&L</th><th>P&L %</th></tr></thead>
        <tbody id="positionsBody"><tr><td colspan="7" class="loading">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Decisions Panel -->
  <div class="panel" id="panel-decisions">
    <button class="refresh-btn" onclick="loadDecisions()">Refresh</button>
    <div id="decisionsContainer"><div class="loading">Loading decisions...</div></div>
  </div>

  <!-- Cycles Panel -->
  <div class="panel" id="panel-cycles">
    <button class="refresh-btn" onclick="loadCycles()">Refresh</button>
    <div id="cyclesContainer"><div class="loading">Loading cycles...</div></div>
  </div>

  <!-- Chat Panel -->
  <div class="panel" id="panel-chat">
    <div class="chat-container">
      <div class="chat-messages" id="chatMessages">
        <div class="empty">Send a message to the AutoTrader bot. You can ask about positions, request a scan, or give trading instructions.</div>
      </div>
      <div class="chat-input-wrap">
        <textarea class="chat-input" id="chatInput" rows="2" placeholder="Ask the bot something... (e.g., 'What are my current positions?' or 'Run a scan now')"></textarea>
        <button class="chat-send" id="chatSend" onclick="sendChat()">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-' + tab.dataset.panel).classList.add('active');
  });
});

function fmt$(n) {
  if (n == null) return '--';
  return '$' + Number(n).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function fmtPct(n) {
  if (n == null) return '--';
  return (Number(n) * 100).toFixed(2) + '%';
}

function fmtTime(ts) {
  if (!ts) return '--';
  const d = new Date(ts);
  return d.toLocaleString('en-US', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

// Overview
async function loadOverview() {
  try {
    const [acctRes, posRes, statusRes] = await Promise.all([
      fetch('/api/account'), fetch('/api/positions'), fetch('/api/status')
    ]);
    const acct = await acctRes.json();
    const positions = await posRes.json();
    const status = await statusRes.json();

    if (!acct.error) {
      document.getElementById('equity').textContent = fmt$(acct.equity);
      document.getElementById('buyingPower').textContent = fmt$(acct.buying_power);
      document.getElementById('cash').textContent = fmt$(acct.cash);
    }

    // Status
    const dot = document.getElementById('statusDot');
    const stxt = document.getElementById('statusText');
    if (status.gateway) {
      dot.className = 'status-dot online';
      stxt.textContent = status.gateway_status;
    } else {
      dot.className = 'status-dot offline';
      stxt.textContent = 'Offline';
    }
    if (status.cron_output) {
      document.getElementById('headerInfo').textContent = status.cron_output.split('\n').slice(1).join(' | ').substring(0, 120);
    }
    if (status.last_session_time) {
      document.getElementById('lastCycle').textContent = fmtTime(status.last_session_time);
    }

    // Positions table
    if (Array.isArray(positions) && positions.length > 0) {
      let totalPL = 0;
      const rows = positions.map(p => {
        const pl = Number(p.unrealized_pl || 0);
        totalPL += pl;
        const plClass = pl >= 0 ? 'pl-positive' : 'pl-negative';
        return `<tr>
          <td><strong>${p.ticker}</strong></td>
          <td>${p.qty}</td>
          <td>${fmt$(p.avg_entry)}</td>
          <td>${fmt$(p.current_price)}</td>
          <td>${fmt$(p.market_value)}</td>
          <td class="${plClass}">${fmt$(pl)}</td>
          <td class="${plClass}">${fmtPct(p.unrealized_plpc)}</td>
        </tr>`;
      }).join('');
      document.getElementById('positionsBody').innerHTML = rows;
      document.getElementById('posCount').textContent = positions.length;

      const plEl = document.getElementById('totalPL');
      plEl.textContent = fmt$(totalPL);
      plEl.className = 'stat-value ' + (totalPL >= 0 ? 'positive' : 'negative');
    } else {
      document.getElementById('positionsBody').innerHTML = '<tr><td colspan="7" class="empty">No open positions</td></tr>';
      document.getElementById('posCount').textContent = '0';
    }
  } catch (e) {
    console.error('Failed to load overview:', e);
  }
}

// Decisions
async function loadDecisions() {
  const container = document.getElementById('decisionsContainer');
  try {
    const res = await fetch('/api/decisions');
    const decisions = await res.json();
    if (!decisions.length) {
      container.innerHTML = '<div class="empty">No trading decisions logged yet. The bot will log decisions during market hours.</div>';
      return;
    }
    container.innerHTML = decisions.map(d => {
      const actionClass = d.action === 'buy' ? 'action-buy' : d.action === 'sell' ? 'action-sell' : 'action-hold';
      return `<div class="entry">
        <div class="entry-header">
          <span class="entry-action ${actionClass}">${d.action || 'unknown'}</span>
          <strong>${d.ticker || ''}</strong>
          <span class="entry-time">${fmtTime(d.timestamp)}</span>
          ${d.confidence ? `<span style="color:var(--yellow)">confidence: ${d.confidence}/10</span>` : ''}
        </div>
        <div class="entry-body">${d.reasoning || ''}</div>
        <div class="entry-meta">
          ${d.rsi != null ? `RSI: ${Number(d.rsi).toFixed(1)}` : ''}
          ${d.shares ? ` | Shares: ${d.shares}` : ''}
          ${d.price ? ` | Price: ${fmt$(d.price)}` : ''}
          ${d.portfolio_value ? ` | Portfolio: ${fmt$(d.portfolio_value)}` : ''}
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    container.innerHTML = '<div class="empty">Error loading decisions</div>';
  }
}

// Cycles
async function loadCycles() {
  const container = document.getElementById('cyclesContainer');
  try {
    const res = await fetch('/api/cycles');
    const cycles = await res.json();
    if (!cycles.length) {
      container.innerHTML = '<div class="empty">No cycle data yet.</div>';
      return;
    }
    container.innerHTML = cycles.map(c => {
      let roleClass = c.role === 'user' ? 'role-user' : c.error ? 'role-error' : 'role-assistant';
      let label = c.role === 'user' ? 'PROMPT' : c.error ? 'ERROR' : 'RESPONSE';
      return `<div class="entry ${roleClass}">
        <div class="entry-header">
          <span class="entry-action" style="background:rgba(88,166,255,0.1);color:var(--accent)">${label}</span>
          ${c.model ? `<span style="font-size:12px;color:var(--muted)">${c.model}</span>` : ''}
          <span class="entry-time">${fmtTime(c.timestamp)}</span>
          ${c.usage?.totalTokens ? `<span style="font-size:11px;color:var(--muted)">${c.usage.totalTokens} tokens</span>` : ''}
        </div>
        <div class="entry-body">${escHtml(c.error || c.text || '(empty)')}</div>
        ${c.thinking ? `<div class="thinking-block">${escHtml(c.thinking)}</div>` : ''}
      </div>`;
    }).join('');
  } catch (e) {
    container.innerHTML = '<div class="empty">Error loading cycles</div>';
  }
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Chat
const chatHistory = [];

async function sendChat() {
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('chatSend');
  const msg = input.value.trim();
  if (!msg) return;

  addChatBubble(msg, 'user');
  input.value = '';
  btn.disabled = true;
  btn.textContent = 'Sending...';

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: msg}),
    });
    const data = await res.json();
    if (data.error) {
      addChatBubble('Error: ' + data.error, 'error');
    } else {
      addChatBubble(data.response || 'No response yet.', 'bot');
    }
  } catch (e) {
    addChatBubble('Network error: ' + e.message, 'error');
  }
  btn.disabled = false;
  btn.textContent = 'Send';
}

function addChatBubble(text, type) {
  const container = document.getElementById('chatMessages');
  const empty = container.querySelector('.empty');
  if (empty) empty.remove();

  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble ' + type;
  bubble.textContent = text;
  container.appendChild(bubble);
  container.scrollTop = container.scrollHeight;
}

document.getElementById('chatInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

// Initial load
loadOverview();

// Auto-refresh every 30s
setInterval(() => {
  const active = document.querySelector('.tab.active');
  if (active) {
    const panel = active.dataset.panel;
    if (panel === 'overview') loadOverview();
    else if (panel === 'decisions') loadDecisions();
    else if (panel === 'cycles') loadCycles();
  }
}, 30000);
</script>

</body>
</html>
